name: CI - Correct Encoding

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-encoding:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Validate file encoding
      run: |
        echo "=== 文件编码验证 ==="
        
        # 检查文件是否存在且可读
        required_files=(
          "README.md"
          ".gitignore"
          "LICENSE"
          ".env.example"
          "docker-compose.yml"
        )
        
        all_good=true
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo -n "✅ $file 存在"
            
            # 检查文件大小
            size=$(wc -c < "$file")
            if [ "$size" -lt 1000000 ]; then  # 小于1MB
              echo " (${size} bytes)"
              
              # 检查是否是Base64编码（简单检查）
              if head -c 100 "$file" | grep -q '^[A-Za-z0-9+/]*=*$' && [ "$size" -gt 100 ]; then
                echo "   ⚠️  警告: 文件可能是Base64编码，而不是文本"
                all_good=false
              else
                echo "   ✓ 看起来是正常文本"
              fi
            else
              echo " (${size} bytes - 文件较大)"
            fi
          else
            echo "❌ $file 不存在"
            all_good=false
          fi
        done
        
        echo ""
        echo "=== 目录结构 ==="
        find . -type f -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.tsx" -o -name "*.json" -o -name "*.yml" -o -name "*.yaml" -o -name "*.md" | head -20
        
        echo ""
        if [ "$all_good" = true ]; then
          echo "✅ 所有文件编码验证通过！"
          exit 0
        else
          echo "❌ 文件编码验证失败"
          exit 1
        fi
    
    - name: Simple syntax checks
      run: |
        echo "=== 简单语法检查 ==="
        
        # 检查Python文件
        if [ -f "backend/main.py" ]; then
          echo "检查Python语法..."
          python3 -m py_compile backend/main.py 2>/dev/null && echo "✅ Python语法正确" || echo "⚠️  Python语法检查跳过（可能依赖缺失）"
        fi
        
        # 检查JSON文件
        for json_file in $(find . -name "*.json" -type f | head -5); do
          echo "检查 $json_file..."
          python3 -m json.tool "$json_file" > /dev/null 2>&1 && echo "  ✅ JSON语法正确" || echo "  ⚠️  JSON语法检查失败"
        done
        
        # 检查YAML文件
        if command -v yq &> /dev/null; then
          for yaml_file in $(find . -name "*.yml" -o -name "*.yaml" -type f | head -5); do
            echo "检查 $yaml_file..."
            yq e '.' "$yaml_file" > /dev/null 2>&1 && echo "  ✅ YAML语法正确" || echo "  ⚠️  YAML语法检查失败"
          done
        else
          echo "⚠️  yq命令未安装，跳过YAML检查"
        fi
        
        echo "✅ 基础语法检查完成"
