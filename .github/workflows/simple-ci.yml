name: Simple CI for EV Knowledge Q&A System

on:
  push:
    branches: [ main, master, feature/ev-knowledge-qa-system ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate project structure
        run: |
          echo "=== ç”µåŠ¨æ±½è½¦çŸ¥è¯†é—®ç­”ç³»ç»Ÿ - é¡¹ç›®ç»“æ„éªŒè¯ ==="
          echo ""
          
          # æ£€æŸ¥å¿…è¦ç›®å½•
          echo "ğŸ“ ç›®å½•æ£€æŸ¥:"
          [ -d "backend" ] && echo "âœ… backendç›®å½•å­˜åœ¨" || echo "âŒ backendç›®å½•ç¼ºå¤±"
          [ -d "frontend" ] && echo "âœ… frontendç›®å½•å­˜åœ¨" || echo "âŒ frontendç›®å½•ç¼ºå¤±"
          [ -d ".github/workflows" ] && echo "âœ… workflowsç›®å½•å­˜åœ¨" || echo "âŒ workflowsç›®å½•ç¼ºå¤±"
          
          echo ""
          echo "ğŸ“„ æ–‡ä»¶æ£€æŸ¥:"
          [ -f "README.md" ] && echo "âœ… README.mdå­˜åœ¨" || echo "âŒ README.mdç¼ºå¤±"
          [ -f ".gitignore" ] && echo "âœ… .gitignoreå­˜åœ¨" || echo "âŒ .gitignoreç¼ºå¤±"
          
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          echo "æ€»æ–‡ä»¶æ•°: $(find . -type f -not -path './.git/*' | wc -l)"
          echo "Pythonæ–‡ä»¶: $(find . -name '*.py' | wc -l)"
          echo "TypeScriptæ–‡ä»¶: $(find . -name '*.ts' -o -name '*.tsx' | wc -l)"
          echo "é…ç½®æ–‡ä»¶: $(find . -name '*.json' -o -name '*.yml' -o -name '*.yaml' | wc -l)"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
          if [ $(find . -type f -not -path './.git/*' | wc -l) -eq 0 ]; then
            echo "âŒ é¡¹ç›®ä¸ºç©ºï¼Œæ²¡æœ‰æ–‡ä»¶"
            exit 1
          fi

  python-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python files
        run: |
          echo "=== Pythonæ–‡ä»¶è¯­æ³•æ£€æŸ¥ ==="
          echo ""
          
          # æŸ¥æ‰¾æ‰€æœ‰Pythonæ–‡ä»¶
          PYTHON_FILES=$(find . -name "*.py" -not -path "./.git/*")
          
          if [ -z "$PYTHON_FILES" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°Pythonæ–‡ä»¶"
            exit 0
          fi
          
          echo "æ‰¾åˆ°Pythonæ–‡ä»¶:"
          echo "$PYTHON_FILES"
          echo ""
          
          # æ£€æŸ¥è¯­æ³•
          echo "ğŸ” è¯­æ³•æ£€æŸ¥:"
          for file in $PYTHON_FILES; do
            echo -n "æ£€æŸ¥ $file ... "
            python3 -m py_compile "$file" 2>/dev/null
            if [ $? -eq 0 ]; then
              echo "âœ…"
            else
              echo "âŒ"
              python3 -m py_compile "$file"
            fi
          done
          
          echo ""
          echo "ğŸ“‹ å¯¼å…¥æ£€æŸ¥ (ä»…æ£€æŸ¥å…³é”®æ–‡ä»¶):"
          if [ -f "backend/app/main.py" ]; then
            echo "æ£€æŸ¥ main.py å¯¼å…¥..."
            python3 -c "
try:
    import sys
    sys.path.insert(0, 'backend')
    from app.main import app
    print('âœ… FastAPIåº”ç”¨å¯¼å…¥æˆåŠŸ')
except Exception as e:
    print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
"
          fi

  typescript-check:
    name: TypeScript Syntax Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check frontend structure
        run: |
          echo "=== å‰ç«¯TypeScriptæ£€æŸ¥ ==="
          echo ""
          
          if [ ! -d "frontend" ]; then
            echo "âš ï¸ frontendç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æŸ¥"
            exit 0
          fi
          
          cd frontend
          
          # æ£€æŸ¥package.json
          if [ ! -f "package.json" ]; then
            echo "âŒ package.jsonä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“¦ package.jsonå­˜åœ¨"
          
          # æ£€æŸ¥tsconfig.json
          if [ ! -f "tsconfig.json" ]; then
            echo "âŒ tsconfig.jsonä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âš™ï¸ tsconfig.jsonå­˜åœ¨"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰TypeScriptæ–‡ä»¶
          TS_FILES=$(find . -name "*.ts" -o -name "*.tsx" -not -path "./node_modules/*")
          
          if [ -z "$TS_FILES" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°TypeScriptæ–‡ä»¶"
            exit 0
          fi
          
          echo "æ‰¾åˆ°TypeScriptæ–‡ä»¶: $(echo "$TS_FILES" | wc -l) ä¸ª"
          
          # ç®€å•è¯­æ³•æ£€æŸ¥ï¼ˆä¸å®‰è£…ä¾èµ–ï¼‰
          echo ""
          echo "ğŸ” ç®€å•è¯­æ³•æ£€æŸ¥:"
          for file in $(echo "$TS_FILES" | head -5); do
            echo -n "æ£€æŸ¥ $file ... "
            if grep -q "import\|export\|interface\|type\|const\|let\|function" "$file"; then
              echo "âœ… åŒ…å«TypeScriptè¯­æ³•"
            else
              echo "âš ï¸ å¯èƒ½ä¸æ˜¯TypeScriptæ–‡ä»¶"
            fi
          done

  final:
    name: Final Report
    runs-on: ubuntu-latest
    needs: [python-check, typescript-check]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "=== ç”µåŠ¨æ±½è½¦çŸ¥è¯†é—®ç­”ç³»ç»Ÿ - CIæ£€æŸ¥æŠ¥å‘Š ==="
          echo ""
          echo "ğŸ“… è¿è¡Œæ—¶é—´: $(date)"
          echo "ğŸ·ï¸ åˆ†æ”¯: ${{ github.ref }}"
          echo ""
          echo "ğŸ“Š ä½œä¸šçŠ¶æ€:"
          echo "  validate: ${{ needs.validate.result }}"
          echo "  python-check: ${{ needs.python-check.result }}"
          echo "  typescript-check: ${{ needs.typescript-check.result }}"
          echo ""
          
          if [[ "${{ needs.validate.result }}" == "success" && \
                "${{ needs.python-check.result }}" == "success" && \
                "${{ needs.typescript-check.result }}" == "success" ]]; then
            echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼é¡¹ç›®ç»“æ„å®Œæ•´ï¼Œè¯­æ³•æ­£ç¡®ã€‚"
            echo ""
            echo "ğŸ’¡ æ¯•ä¸šè®¾è®¡é¡¹ç›®çŠ¶æ€:"
            echo "  âœ… é¡¹ç›®ç»“æ„å®Œæ•´"
            echo "  âœ… Pythonä»£ç è¯­æ³•æ­£ç¡®"
            echo "  âœ… TypeScriptä»£ç ç»“æ„å®Œæ•´"
            echo "  âœ… ç¬¦åˆæ¯•ä¸šè®¾è®¡åŸºæœ¬è¦æ±‚"
          else
            echo "âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ï¼Œéœ€è¦ä¿®å¤ä»¥ä¸‹é—®é¢˜:"
            echo ""
            if [[ "${{ needs.validate.result }}" != "success" ]]; then
              echo "  âŒ é¡¹ç›®ç»“æ„éªŒè¯å¤±è´¥"
            fi
            if [[ "${{ needs.python-check.result }}" != "success" ]]; then
              echo "  âŒ Pythonè¯­æ³•æ£€æŸ¥å¤±è´¥"
            fi
            if [[ "${{ needs.typescript-check.result }}" != "success" ]]; then
              echo "  âŒ TypeScriptæ£€æŸ¥å¤±è´¥"
            fi
            echo ""
            echo "ğŸ”§ å»ºè®®:"
            echo "  1. æ£€æŸ¥ç¼ºå¤±çš„ç›®å½•å’Œæ–‡ä»¶"
            echo "  2. ä¿®å¤Pythonè¯­æ³•é”™è¯¯"
            echo "  3. å®Œå–„å‰ç«¯TypeScripté…ç½®"
          fi
          
          echo ""
          echo "ğŸš€ ä¸‹ä¸€æ­¥:"
          echo "  1. æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹"
          echo "  2. å®Œå–„åŠŸèƒ½å®ç°"
          echo "  3. å‡†å¤‡é¡¹ç›®æ¼”ç¤º"
          echo "  4. æ’°å†™æ¯•ä¸šè®¾è®¡è®ºæ–‡"